name: Flatpak Release

on:
  pull_request:
    paths:
      - '.github/workflows/flatpakci.yml'
  workflow_dispatch:

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  build:
    name: Build Tauri
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 3072
          root-reserve-mb: 6144
          remove-dotnet: 'true'
          remove-codeql: 'true'
          remove-haskell: 'true'
          remove-docker-images: 'true'
          
      - name: Clone Spacedrive to Working DIR
        run: |
          git clone https://github.com/spacedriveapp/spacedrive spacedrive
          mv spacedrive/* ./
          mv spacedrive/.github ./
          mv spacedrive/.[!.]* ./
          rm -rf spacedrive
          ls ./

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-pnpm

      - name: Setup System and Rust
        uses: ./.github/actions/setup-system
        with:
          target: x86_64-unknown-linux-gnu
          
      - name: Build Tauri
        run:  |
          pnpm tauri build --ci -v --target x86_64-unknown-linux-gnu --bundles deb

      - name: Upload Tauri Build
        uses: ./.github/actions/publish-artifacts
        with:
          os: linux
          arch: x86_64
          target: x86_64-unknown-linux-gnu
          profile: release
          
  flatpak-build:
    runs-on: ubuntu-22.04
    name: Flatpak Build
    needs: build
    permissions:
      contents: write
    steps:
  
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: new-pr

      - name: Download artifacts
        uses: actions/download-artifact@v4
      
      - name: Add Submodules
        run: git submodule add https://github.com/flathub/shared-modules.git
        
      - name: Install FlatPak dependencies
        run: |
          df -h
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev webkit2gtk-4.0 librsvg2-dev patchelf flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install -y runtime/org.gnome.Platform/x86_64/46 runtime/org.gnome.Sdk/x86_64/46
          flatpak --version
          flatpak-builder --version
          ls
      - name: Create App Metainfo
        run: |
          cat << EOF > ./com.spacedrive.Desktop.metainfo.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <!-- Copyright 2024 Spacedrive Technology Inc -->
          <component type="desktop-application">
            <id>com.spacedrive.Desktop</id>
            <name>Spacedrive</name>
            <summary>Spacedrive is an open source cross-platform file explorer, powered by a virtual distributed filesystem written in Rust. </summary>
            <metadata_license>CC0-1.0</metadata_license>
            <project_license>AGPL-3.0-only</project_license>
            <developer id="com.spacedrive">
              <name>Spacedrive Technology Inc</name>
            </developer>
            <description>
              <p>Organize files across many devices in one place. From cloud services to offline hard drives, Spacedrive combines the storage capacity and processing power of your devices into one personal distributed cloud, that is both secure and intuitive to use.</p>
              <p>For independent creatives, hoarders, and those that want to own their digital footprint, Spacedrive provides a free file management experience like no other.</p>
            </description>
            <launchable type="desktop-id">com.spacedrive.Desktop.desktop</launchable>
            <icon type="remote">https://github.com/spacedriveapp/spacedrive/raw/main/packages/assets/images/AppLogo.png</icon>
            <url type="bugtracker">https://github.com/spacedriveapp/spacedrive/issues</url>
            <url type="homepage">https://spacedrive.com/</url>
            <url type="contribute">https://github.com/spacedriveapp/spacedrive/</url>
            <screenshots>
              <screenshot type="default">
                <image>https://github.com/spacedriveapp/spacedrive/raw/main/apps/landing/public/github.webp</image>
                <caption>Spacedrive</caption>
              </screenshot>
            </screenshots>
            <content_rating type="oars-1.1">
              <content_attribute id="social-info">mild</content_attribute>
            </content_rating>
            <releases>
              <release version="0.4.0" date="2024-07-20">
                <url type="details">https://www.spacedrive.com/docs/changelog/alpha/0.4.0</url>
                <description>
                  <p>Release description</p>
                    <ul>
                      <li>Improved file system indexer - by @fogodev in #2476</li>
                      <li>Estimated time remaining on Jobs - by @myung03</li>
                      <li>Device and database sync [Feature Flagged] -  Big team effort ðŸ˜€</li>
                    </ul>
                </description>
              </release>
              <release version="0.3.0" date="2024-05-31">
                <url type="details">https://www.spacedrive.com/docs/changelog/alpha/0.3.0</url>
                <description>
                  <p>Release description</p>
                    <ul>
                      <li>sd-core-sync documentation by @Brendonovich in #2511</li>
                      <li>Disable AppNap for macOS and fix app version in deb by @HeavenVolkoff in #2517</li>
                      <li>Fix server release by @HeavenVolkoff in #2518</li>
                      <li>More P2P docs by @oscartbeaumont in #2492</li>
                      <li>Serve files over p2p by @oscartbeaumont in #2523</li>
                      <li>Alpha 0.3.1 by @utkubakir in #2526</li>
                      <li>[ENG-1776] Delete cloud ops after they've been ingested by @Brendonovich in #2512</li>
                      <li>More More P2P Docs by @oscartbeaumont in #2525</li>
                    </ul>
                </description>
              </release>
            </releases>
            <supports>
              <control>pointing</control>
              <control>keyboard</control>
            </supports>
            <recommends>
              <display_length compare="ge">200</display_length>
            </recommends>
          </component>
          EOF
          
      - name: Create Flatpak Manifest
        run: |
          cat << EOF > ./com.spacedrive.Desktop.yml
          id: com.spacedrive.Desktop
          runtime: org.gnome.Platform
          runtime-version: '46'
          sdk: org.gnome.Sdk
                    
          command: /app/bin/spacedrive
          finish-args:
            - --env=LD_LIBRARY_PATH=/app/lib/spacedrive:/usr/lib
            - --socket=wayland
            - --socket=fallback-x11
            - --device=dri
            - --allow=bluetooth
            - --share=ipc
            - --share=network
            - --socket=pulseaudio
            - --socket=cups
            - --device=dri
            - --filesystem=host
            - --filesystem=/mnt
                    
          modules:
            - name: xdotool
              buildsystem: simple
              sources:
                - type: git
                  url: https://github.com/jordansissel/xdotool.git
              depends: glibc
              build-commands:
                - make
                - make install PREFIX=/app/lib/spacedrive
            - shared-modules/dbus-glib/dbus-glib.json
            - name: binary
              buildsystem: simple
              sources:
                - type: file
                  path: Spacedrive-linux-x86_64.deb 
                  only-arches: [x86_64]
                - type: file
                  path: com.spacedrive.Desktop.metainfo.xml
                            
              build-commands:
                - ar -x *.deb
                - tar -xf data.tar.gz
                - sed -i 's/Icon=sd-desktop/Icon=com.spacedrive.Desktop/' usr/share/applications/spacedrive.desktop
                - mkdir -p /app/lib/spacedrive
                - mkdir -p /app/share/doc/spacedrive
                - mkdir -p /app/share/spacedrive/models
                - mkdir -p /app/share/man/man1/
                - mkdir -p /app/share/doc/spacedrive
                - mkdir -p /app/bin
                - mkdir -p /app/share/spacedrive/models
                - cp -r /app/lib/spacedrive/lib/*.so* /app/lib/spacedrive
                - cp -r /app/lib/*.so* /app/lib/spacedrive
                - cp -r usr/lib/spacedrive/* /app/lib/spacedrive
                - cp -r usr/bin/* /app/bin
                - cp -r usr/share/man/man1/* /app/share/man/man1/
                - install -Dm644 usr/share/icons/hicolor/128x128/apps/spacedrive.png /app/share/icons/hicolor/128x128/apps/com.spacedrive.Desktop.png
                - install -Dm644 usr/share/icons/hicolor/32x32/apps/spacedrive.png /app/share/icons/hicolor/32x32/apps/com.spacedrive.Desktop.png
                - install -Dm644 usr/share/icons/hicolor/256x256@2/apps/spacedrive.png /app/share/icons/hicolor/256x256/apps/com.spacedrive.Desktop.png
                - cp -r usr/share/doc/spacedrive/* /app/share/doc/spacedrive
                - install -Dm644 usr/share/applications/spacedrive.desktop /app/share/applications/com.spacedrive.Desktop.desktop
                - cp -r usr/share/spacedrive/models/* /app/share/spacedrive/models
                - install -Dm644 com.spacedrive.Desktop.metainfo.xml /app/share/metainfo/com.spacedrive.Desktop.metainfo.xml

          EOF
          
      - name: Build Flatpak
        run: flatpak-builder --repo=local ./out ./com.spacedrive.Desktop.yml
            
      - name: Build Flatpak Bundle
        run: flatpak build-bundle local com.spacedrive.Desktop.flatpak com.spacedrive.Desktop

      - name: Upload Flatpak Bundle
        uses: actions/upload-artifact@v3
        with:
          name: com.spacedrive.Desktop.flatpak
          path: ./com.spacedrive.Desktop.flatpak
